# Javascript Node CircleCI configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2.1
defaults: &defaults
  working_directory: ~/repo
  docker:
    - image: circleci/openjdk:11.0.2-jdk-node

orbs:
  win: circleci/windows@2.2.0 # The Windows orb give you everything you need to start using the Windows executor.
  gradle: circleci/gradle@2.2.0
  node: circleci/node@4.5.1


commands:
  auth_and_checkout:
    steps:
      - add_ssh_keys:
          fingerprints:
            # CircleCI deploy key, allows CircleCI to checkout code from Github.
            - "63:74:04:09:64:97:7e:c6:9b:45:c0:5e:d3:7e:40:ed"
      - checkout
  windows_install_yarn:
    steps:
      - run:
          name: "Install yarn"
          shell: bash.exe
          command: npm install -g yarn

jobs:
  linux-rc-test:
    <<: *defaults
    steps:
      - auth_and_checkout

      # We want our unit tests to run with the lts version of node.
      - node/install:
          install-npm: false
          lts: true

      # Log the version of node we're using after the upgrade.
      - run: node -v

      - run:
          name: "Install sfdx-cli"
          command: npm install -g sfdx-cli

      - run:
          name: "Install release candidate"
          command: sfdx plugins:install --force @salesforce/sfdx-scanner

      - run: mkdir smoke-test-results

      - run:
          # Run through our sanity test script against the installed version of the plugin. If all of these pass, we can
          # assume that the plugin is stable.
          name: "Packaged sanity test"
          command: smoke-tests/smoke-test.sh sfdx

          # Upload an artifact for the results, so they're visible without failing the tests
          - store_artifacts:
              path: smoke-test-results


  windows-rc-test:
    executor:
      name: win/default # executor type
      size: "medium"

    steps:
      - auth_and_checkout

      - run:
          name: "Upgrade node to LTS"
          shell: bash.exe
          command: .circleci/windows-node-upgrade.sh lts

      # After upgrading the node version in a Windows executor, we have to manually reinstall Yarn if we want to use it.
      - windows_install_yarn

      # Log the version of node we're using after the upgrade.
      - run: node -v

      - run:
          name: "Install sfdx cli"
          shell: cmd.exe
          command: npm install -g sfdx-cli

      - run:
          name: "Install release candidate"
          shell: cmd.exe
          command: sfdx plugins:install --force @salesforce/sfdx-scanner

      - run: mkdir smoke-test-results

      - run:
          # Run through our sanity test script against the installed version of the plugin. If all of these pass, we can
          # assume that the plugin is stable.
          name: "Packaged sanity test"
          command: smoke-tests\smoke-test.cmd sfdx

      # Upload an artifact for the results, so they're visible without failing the tests
      - store_artifacts:
          path: smoke-test-results

workflows:
  version: 2.1
  test-publish:
    jobs:
      - linux-rc-test
      - windows-rc-test
